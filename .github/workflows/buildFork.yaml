name: Build and Upload

on:
  workflow_call:
    inputs:
      branch:
        required: false
        type: string
        default: main

permissions:
    contents: write
    actions: write
    repository-projects: write
    pull-requests: write
  
jobs:
    shellcheck:
      uses: ./.github/workflows/shellcheck.yml
      with:
        branch: ${{ inputs.branch }}
    shfmt:
      uses: ./.github/workflows/shfmt.yml
      with:
        branch: ${{ inputs.branch }}
    repocheck:
      uses: ./.github/workflows/repocheck.yml
      with:
        branch: ${{ inputs.branch }}
    build-and-push:
        needs: [shellcheck, shfmt, repocheck]
        strategy:
            matrix:
                image: [ 
                        mirte_orangepizero2,
                        mirte_orangepizero2_rt,
                        mirte_orangepi3b,
                        mirte_orangepi3b_rt,
                        # mirte_rpi4b,
                        # mirte_orangepizero2_noble
                        ]
            fail-fast: false
        uses: ./.github/workflows/build_single.yaml
        with:
          sbc: ${{ matrix.image }}
          branch: ${{ inputs.branch }}
        if:  ${{ ! startsWith(github.event.head_commit.message, 'x')}}
        secrets: inherit
    master-build-and-push:
        needs: [shellcheck, shfmt, repocheck]
        if:  ${{ ! startsWith(github.event.head_commit.message, 'x') }}
        strategy:
            matrix:
                image: [ 
                        mirte_orangepi3b,
                        mirte_orangepi3b_rt,
                        ]
            fail-fast: false
        uses: ./.github/workflows/build_single.yaml
        with:
          mirte_type: mirte-master
          sbc: mirte_orangepi3b
          branch: ${{ inputs.branch }}
        secrets: inherit
    overlay-build-and-push:
        needs: [shellcheck, shfmt, repocheck]
        if:  ${{ ! startsWith(github.event.head_commit.message, 'x') }}
        uses: ./.github/workflows/create_overlay.yaml
        with:
          branch: ${{ inputs.branch }}
        secrets: inherit
      
            
